<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>Unity WebGL — Embedded Mobile (Fullscreen = Landscape)</title>
  <style>
    :root { --bg: #0f0f12; --maxw: 900px; }
    html, body { margin:0; background: var(--bg); color:#e9e9ee; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans'; }
    .page {
      padding: 16px; display: grid; gap: 12px; place-content: start center;
      min-height: 100dvh; box-sizing: border-box;
    }
    .blurb { max-width: var(--maxw); opacity:.8; font-size: .95rem; }
    .unity-shell {
      width: 100%; max-width: var(--maxw);
    }
    .unity-container {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      background: #000;
      border-radius: 14px;
      overflow: clip;
      box-shadow: 0 8px 40px rgba(0,0,0,.35);
    }
    #unity-canvas {
      position: absolute; inset: 0;
      width: 100%; height: 100%; display: block;
      outline: none;
      touch-action: none;
      -webkit-user-select: none; user-select: none;
    }
    .progress {
      position:absolute; inset:0;
      display:grid; place-items:center;
    }
    .progress[hidden]{ display:none; }
    .toolbar {
      display:flex; justify-content:space-between; align-items:center; gap:8px;
      margin-top: 8px;
    }
    .toolbar button {
      padding: 10px 14px; border-radius: 12px; border: 0; background: #1c1f29; color: #e9e9ee;
    }
    .small { opacity:.7; font-size:.9rem; }

    /* Fullscreen rotate fallback overlay */
    .rotate-overlay {
      position: fixed; inset: 0; display: none;
      align-items: center; justify-content: center; text-align: center;
      background: rgba(0,0,0,.8); z-index: 9999; padding: 24px;
    }
    .rotate-overlay.active { display: flex; }
    .rotate-card { max-width: 420px; }
    .rotate-card h2 { margin: 0 0 8px 0; font-size: 1.1rem; }
    .rotate-card p { margin: 0; opacity:.85; }
  </style>
</head>
<body>
  <div class="page">
    <div class="blurb">
      <strong>Embedded demo (mobile-friendly):</strong> sits inside the page. If the user taps <em>Fullscreen</em>, we request fullscreen and lock to landscape (where supported). If not supported, we show a rotate hint overlay.
    </div>

    <div class="unity-shell">
      <div class="unity-container" id="unity-container">
        <canvas id="unity-canvas" tabindex="0"></canvas>
        <div id="progress" class="progress">Loading… 0%</div>
      </div>
      <div class="toolbar">
        <div class="small">Canvas is embedded (not fullscreen) by default.</div>
        <div>
          <button id="btn-audio">Enable Audio</button>
          <button id="btn-fullscreen">Fullscreen</button>
        </div>
      </div>
    </div>
  </div>

  <div class="rotate-overlay" id="rotate-overlay" role="dialog" aria-live="polite" aria-label="Rotate device">
    <div class="rotate-card">
      <h2>Please rotate your device</h2>
      <p>For the best experience, use landscape while in fullscreen.</p>
    </div>
  </div>

  <script>
    // --- Unity Build Paths ---
    const buildUrl  = "Build";
    const loaderUrl = buildUrl + "/CementosArtigasWeb.loader.js";
    const config = {
      dataUrl:      buildUrl + "/CementosArtigasWeb.data.unityweb",
      frameworkUrl: buildUrl + "/CementosArtigasWeb.framework.js.unityweb",
      codeUrl:      buildUrl + "/CementosArtigasWeb.wasm.unityweb",
      streamingAssetsUrl: "StreamingAssets",
      companyName: "MM",
      productName: "Cementos-Artigas-Game",
      productVersion: "1.0",
      devicePixelRatio: Math.min(1.5, window.devicePixelRatio || 1),
      matchWebGLToCanvasSize: true
    };

    const container = document.getElementById("unity-container");
    const canvas = document.getElementById("unity-canvas");
    const progressEl = document.getElementById("progress");
    const fsBtn = document.getElementById("btn-fullscreen");
    const audioBtn = document.getElementById("btn-audio");
    const rotateOverlay = document.getElementById("rotate-overlay");

    // iOS/Android audio policy: resume AudioContext on a user gesture
    function resumeAudio() {
      try {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (AC) {
          if (!window._ac) window._ac = new AC();
          if (window._ac.state === "suspended") window._ac.resume();
        }
      } catch (e) { /* ignore */ }
    }

    // Utilities for fullscreen
    function enterFullscreen(el) {
      if (el.requestFullscreen) return el.requestFullscreen();
      if (el.webkitRequestFullscreen) return el.webkitRequestFullscreen();
      if (el.msRequestFullscreen) return el.msRequestFullscreen();
      return Promise.reject(new Error("Fullscreen API not supported"));
    }
    function exitFullscreen() {
      if (document.exitFullscreen) return document.exitFullscreen();
      if (document.webkitExitFullscreen) return document.webkitExitFullscreen();
      if (document.msExitFullscreen) return document.msExitFullscreen();
      return Promise.resolve();
    }
    function isFullscreen() {
      return !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
    }

    // Try to lock landscape after entering fullscreen (where supported)
    async function lockLandscapeIfPossible() {
      const so = screen.orientation;
      if (so && so.lock) {
        try {
          await so.lock('landscape');
          return true;
        } catch (e) {
          // Lock failed (likely unsupported on iOS Safari or user settings)
          return false;
        }
      }
      return false;
    }

    // Show/hide rotate overlay based on current orientation while fullscreen
    function updateRotateOverlay() {
      const inFs = isFullscreen();
      const isLandscape = window.matchMedia('(orientation: landscape)').matches;
      rotateOverlay.classList.toggle('active', inFs && !isLandscape);
    }

    // Listen for fullscreen & orientation changes
    ['fullscreenchange','webkitfullscreenchange','msfullscreenchange'].forEach(ev =>
      document.addEventListener(ev, updateRotateOverlay)
    );
    if (screen.orientation && screen.orientation.addEventListener) {
      screen.orientation.addEventListener('change', updateRotateOverlay);
    }
    window.addEventListener('resize', updateRotateOverlay);

    // Boot Unity
    const script = document.createElement("script");
    script.src = loaderUrl;
    script.onload = () => {
      createUnityInstance(canvas, config, (p) => {
        progressEl.textContent = "Loading… " + Math.round(p * 100) + "%";
      }).then((unityInstance) => {
        progressEl.hidden = true;
        window.unityInstance = unityInstance;

        // Fullscreen button: enter FS, then try to lock landscape
        fsBtn.onclick = async () => {
          resumeAudio();
          try {
            // Prefer letting Unity manage fullscreen if available;
            // however, we also request FS on the container so we can catch events/lock orientation.
            await enterFullscreen(container);
          } catch (e) {
            // Fallback: try Unity's own path
            if (unityInstance.SetFullscreen) unityInstance.SetFullscreen(1);
          }
          const locked = await lockLandscapeIfPossible();
          // If not locked and device is portrait, show hint overlay
          updateRotateOverlay();
        };

        // Audio button for iOS first-gesture unlocks
        audioBtn.onclick = () => resumeAudio();
      }).catch((err) => {
        progressEl.textContent = "Failed to load: " + err;
        console.error(err);
      });
    };
    script.onerror = () => {
      progressEl.textContent = "Failed to load loader script. Check path: " + loaderUrl;
    };
    document.body.appendChild(script);
  </script>
</body>
</html>
